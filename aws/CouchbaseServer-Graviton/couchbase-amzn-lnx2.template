{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Couchbase Enterprise Edition Server on Amazon Linux 2 - Graviton with Multi-Dimensional Scaling",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Network Configuration/Access"
                    },
                    "Parameters": [
                        "VpcName",
                        "Subnets",
                        "SSHCIDR",
                        "KeyName"
                    ]
                },
                {
                    "Label": {
                        "default": "Core Server Configuration"
                    },
                    "Parameters": [
                        "CoreInstanceCount",
                        "CoreDiskSize",
                        "CoreDiskType",
                        "ServerVersion",
                        "CoreInstanceType",
                        "CoreServices",
                        "Username",
                        "Password"
                    ]
                },{
                    "Label": {
                        "default": "Multi-Dimension Scaling Configuration"
                    },
                    "Parameters":[
                        "AnalyticsInstanceCount",
                        "AnalyticsInstanceType",
                        "SearchInstanceCount",
                        "SearchInstanceType",
                        "EventingInstanceCount",
                        "EventingInstanceType",
                        "BackupInstanceCount",
                        "BackupInstanceType",
                        "DataInstanceCount",
                        "DataInstanceType",
                        "QueryInstanceCount",
                        "QueryInstanceType",
                        "IndexInstanceCount",
                        "IndexInstanceType"
                    ]
                }
            ],
            "ParameterLabels": {
                "SSHCIDR": {
                    "default": "Access CIDR"
                },
                "Username": {
                    "default": "Database Username"
                },
                "Password": {
                    "default": "Database Password"
                }
            }
        }
    },
    "Mappings": {},
    "Parameters": {
        "CoreInstanceCount": {
            "Description": "Number of core Couchbase Server Nodes",
            "Type": "Number",
            "Default": 3
        },
        "CoreDiskSize": {
            "Description": "Size in GB of the EBS gp2 volume on each core Couchbase node",
            "Type": "Number",
            "Default": 100
        },
        "CoreDiskType": {
            "Description": "Type of disk to use for the core data volumes",
            "Type": "String",
            "Default": "gp3",
            "AllowedValues": [
                "gp3",
                "gp2",
                "io1",
                "st1",
                "sc1"
            ]
        },
        "ServerVersion": {
            "Description": "Couchbase Server Version",
            "Type": "String",
            "Default": "8.0.0",
            "AllowedValues": [
                "7.1.0",
                "7.1.1",
                "7.1.2",
                "7.1.3",
                "7.1.4",
                "7.2.0",
                "7.2.2",
                "7.2.3",
                "7.2.4",
                "7.2.5",
                "7.6.0",
                "7.6.1",
                "7.6.2",
                "7.6.3",
                "7.6.4",
                "7.6.5",
                "7.6.6",
                "7.6.7",
                "8.0.0"
            ]
        },
        "CoreInstanceType": {
            "Description": "Instance type for Couchbase Nodes",
            "Type": "String",
            "Default": "m6g.xlarge",
            "AllowedValues": [
                "m6g.16xlarge",
                "m6g.metal",
                "m6gd.large",
                "m6gd.xlarge",
                "m6gd.2xlarge",
                "m6gd.4xlarge",
                "m6gd.8xlarge",
                "m6gd.12xlarge",
                "m6gd.16xlarge",
                "m6gd.metal",
                "r6g.large",
                "r6g.xlarge",
                "r6g.2xlarge",
                "r6g.4xlarge",
                "r6g.8xlarge",
                "r6g.12xlarge",
                "r6g.16xlarge",
                "r6g.metal",
                "r6gd.large",
                "r6gd.xlarge",
                "r6gd.2xlarge",
                "r6gd.4xlarge",
                "r6gd.8xlarge",
                "r6gd.12xlarge",
                "r6gd.16xlarge",
                "r6gd.metal",
                "r7g.large",
                "r7g.xlarge",
                "r7g.2xlarge",
                "r7g.4xlarge",
                "r7g.8xlarge",
                "r7g.12xlarge",
                "r7g.16xlarge",
                "r7g.metal",
                "r7gd.large",
                "r7gd.xlarge",
                "r7gd.2xlarge",
                "r7gd.4xlarge",
                "r7gd.8xlarge",
                "r7gd.12xlarge",
                "r7gd.16xlarge",
                "r7gd.metal",
                "t4g.nano",
                "t4g.micro",
                "t4g.small",
                "t4g.medium",
                "t4g.large",
                "t4g.xlarge",
                "t4g.2xlarge",
                "x2gd.large",
                "x2gd.xlarge",
                "x2gd.2xlarge",
                "x2gd.4xlarge",
                "x2gd.8xlarge",
                "x2gd.12xlarge",
                "x2gd.16xlarge",
                "x2gd.metal",
                "m6g.12xlarge",
                "a1.large",
                "a1.xlarge",
                "a1.2xlarge",
                "a1.4xlarge",
                "a1.metal",
                "c6g.large",
                "c6g.xlarge",
                "c6g.2xlarge",
                "c6g.4xlarge",
                "c6g.8xlarge",
                "c6g.12xlarge",
                "c6g.16xlarge",
                "c6g.metal",
                "c6gd.large",
                "c6gd.xlarge",
                "c6gd.2xlarge",
                "c6gd.4xlarge",
                "c6gd.8xlarge",
                "c6gd.12xlarge",
                "c6gd.16xlarge",
                "c6gd.metal",
                "c6gn.large",
                "c6gn.xlarge",
                "c6gn.2xlarge",
                "c6gn.4xlarge",
                "c6gn.8xlarge",
                "c6gn.12xlarge",
                "c6gn.16xlarge",
                "c7g.large",
                "c7g.xlarge",
                "c7g.2xlarge",
                "c7g.4xlarge",
                "c7g.8xlarge",
                "c7g.12xlarge",
                "c7g.16xlarge",
                "c7g.metal",
                "c7gd.large",
                "c7gd.xlarge",
                "c7gd.2xlarge",
                "c7gd.4xlarge",
                "c7gd.8xlarge",
                "c7gd.12xlarge",
                "c7gd.16xlarge",
                "c7gd.metal",
                "g5g.xlarge",
                "g5g.2xlarge",
                "g5g.4xlarge",
                "g5g.8xlarge",
                "g5g.16xlarge",
                "g5g.metal",
                "im4gn.large",
                "im4gn.xlarge",
                "im4gn.2xlarge",
                "im4gn.4xlarge",
                "im4gn.8xlarge",
                "im4gn.16xlarge",
                "is4gen.large",
                "is4gen.xlarge",
                "is4gen.2xlarge",
                "is4gen.4xlarge",
                "is4gen.8xlarge",
                "m6g.large",
                "m6g.xlarge",
                "m6g.2xlarge",
                "m6g.4xlarge",
                "m6g.8xlarge",
                "a1.medium",
                "c6g.medium",
                "c6gd.medium",
                "c6gn.medium",
                "is4gen.medium"
            ]
        },
        "CoreServices": {
            "Description": "Comma delimited list of services, can include any combination of:  data, index, query, fts, analytics, eventing and backup",
            "Type": "CommaDelimitedList",
            "Default": "data,index,query"
        },
        "Username": {
            "Description": "Username for Couchbase administrator",
            "Type": "String"
        },
        "Password": {
            "Description": "Password for Couchbase administrator",
            "Type": "String",
            "NoEcho": true
        },
        "KeyName": {
            "Description": "Name of an existing EC2 KeyPair",
            "Type": "AWS::EC2::KeyPair::KeyName"
        },
        "SSHCIDR": {
            "Description": "SSH CIDR",
            "Type": "String",
            "MinLength": 9,
            "MaxLength": 18,
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x."
        },
        "VpcName": {
            "Type": "AWS::EC2::VPC::Id",
            "Description": "VPC Identifier"
        },
        "Subnets": {
            "Description": "Subnets List (Note:  If you select a private subnet without egress to the internet, the template will fail to deploy correctly)",
            "Type": "List<AWS::EC2::Subnet::Id>"
        },
        "AnalyticsInstanceCount": {
            "Description": "Number of Couchbase Analytics Nodes",
            "Type": "Number",
            "Default": 0
        },
        "AnalyticsInstanceType": {
            "Description": "Instance type for Couchbase Analytics Nodes",
            "Type": "String",
            "Default": "m6g.xlarge",
            "AllowedValues": [
                "m6g.16xlarge",
                "m6g.metal",
                "m6gd.large",
                "m6gd.xlarge",
                "m6gd.2xlarge",
                "m6gd.4xlarge",
                "m6gd.8xlarge",
                "m6gd.12xlarge",
                "m6gd.16xlarge",
                "m6gd.metal",
                "r6g.large",
                "r6g.xlarge",
                "r6g.2xlarge",
                "r6g.4xlarge",
                "r6g.8xlarge",
                "r6g.12xlarge",
                "r6g.16xlarge",
                "r6g.metal",
                "r6gd.large",
                "r6gd.xlarge",
                "r6gd.2xlarge",
                "r6gd.4xlarge",
                "r6gd.8xlarge",
                "r6gd.12xlarge",
                "r6gd.16xlarge",
                "r6gd.metal",
                "r7g.large",
                "r7g.xlarge",
                "r7g.2xlarge",
                "r7g.4xlarge",
                "r7g.8xlarge",
                "r7g.12xlarge",
                "r7g.16xlarge",
                "r7g.metal",
                "r7gd.large",
                "r7gd.xlarge",
                "r7gd.2xlarge",
                "r7gd.4xlarge",
                "r7gd.8xlarge",
                "r7gd.12xlarge",
                "r7gd.16xlarge",
                "r7gd.metal",
                "t4g.nano",
                "t4g.micro",
                "t4g.small",
                "t4g.medium",
                "t4g.large",
                "t4g.xlarge",
                "t4g.2xlarge",
                "x2gd.large",
                "x2gd.xlarge",
                "x2gd.2xlarge",
                "x2gd.4xlarge",
                "x2gd.8xlarge",
                "x2gd.12xlarge",
                "x2gd.16xlarge",
                "x2gd.metal",
                "m6g.12xlarge",
                "a1.large",
                "a1.xlarge",
                "a1.2xlarge",
                "a1.4xlarge",
                "a1.metal",
                "c6g.large",
                "c6g.xlarge",
                "c6g.2xlarge",
                "c6g.4xlarge",
                "c6g.8xlarge",
                "c6g.12xlarge",
                "c6g.16xlarge",
                "c6g.metal",
                "c6gd.large",
                "c6gd.xlarge",
                "c6gd.2xlarge",
                "c6gd.4xlarge",
                "c6gd.8xlarge",
                "c6gd.12xlarge",
                "c6gd.16xlarge",
                "c6gd.metal",
                "c6gn.large",
                "c6gn.xlarge",
                "c6gn.2xlarge",
                "c6gn.4xlarge",
                "c6gn.8xlarge",
                "c6gn.12xlarge",
                "c6gn.16xlarge",
                "c7g.large",
                "c7g.xlarge",
                "c7g.2xlarge",
                "c7g.4xlarge",
                "c7g.8xlarge",
                "c7g.12xlarge",
                "c7g.16xlarge",
                "c7g.metal",
                "c7gd.large",
                "c7gd.xlarge",
                "c7gd.2xlarge",
                "c7gd.4xlarge",
                "c7gd.8xlarge",
                "c7gd.12xlarge",
                "c7gd.16xlarge",
                "c7gd.metal",
                "g5g.xlarge",
                "g5g.2xlarge",
                "g5g.4xlarge",
                "g5g.8xlarge",
                "g5g.16xlarge",
                "g5g.metal",
                "im4gn.large",
                "im4gn.xlarge",
                "im4gn.2xlarge",
                "im4gn.4xlarge",
                "im4gn.8xlarge",
                "im4gn.16xlarge",
                "is4gen.large",
                "is4gen.xlarge",
                "is4gen.2xlarge",
                "is4gen.4xlarge",
                "is4gen.8xlarge",
                "m6g.large",
                "m6g.xlarge",
                "m6g.2xlarge",
                "m6g.4xlarge",
                "m6g.8xlarge",
                "a1.medium",
                "c6g.medium",
                "c6gd.medium",
                "c6gn.medium",
                "is4gen.medium"
            ]
        },
        "EventingInstanceCount": {
            "Description": "Number of Couchbase Eventing Nodes",
            "Type": "Number",
            "Default": 0
        },
        "EventingInstanceType": {
            "Description": "Instance type for Couchbase Eventing Nodes",
            "Type": "String",
            "Default": "m6g.xlarge",
            "AllowedValues": [
                "m6g.16xlarge",
                "m6g.metal",
                "m6gd.large",
                "m6gd.xlarge",
                "m6gd.2xlarge",
                "m6gd.4xlarge",
                "m6gd.8xlarge",
                "m6gd.12xlarge",
                "m6gd.16xlarge",
                "m6gd.metal",
                "r6g.large",
                "r6g.xlarge",
                "r6g.2xlarge",
                "r6g.4xlarge",
                "r6g.8xlarge",
                "r6g.12xlarge",
                "r6g.16xlarge",
                "r6g.metal",
                "r6gd.large",
                "r6gd.xlarge",
                "r6gd.2xlarge",
                "r6gd.4xlarge",
                "r6gd.8xlarge",
                "r6gd.12xlarge",
                "r6gd.16xlarge",
                "r6gd.metal",
                "r7g.large",
                "r7g.xlarge",
                "r7g.2xlarge",
                "r7g.4xlarge",
                "r7g.8xlarge",
                "r7g.12xlarge",
                "r7g.16xlarge",
                "r7g.metal",
                "r7gd.large",
                "r7gd.xlarge",
                "r7gd.2xlarge",
                "r7gd.4xlarge",
                "r7gd.8xlarge",
                "r7gd.12xlarge",
                "r7gd.16xlarge",
                "r7gd.metal",
                "t4g.nano",
                "t4g.micro",
                "t4g.small",
                "t4g.medium",
                "t4g.large",
                "t4g.xlarge",
                "t4g.2xlarge",
                "x2gd.large",
                "x2gd.xlarge",
                "x2gd.2xlarge",
                "x2gd.4xlarge",
                "x2gd.8xlarge",
                "x2gd.12xlarge",
                "x2gd.16xlarge",
                "x2gd.metal",
                "m6g.12xlarge",
                "a1.large",
                "a1.xlarge",
                "a1.2xlarge",
                "a1.4xlarge",
                "a1.metal",
                "c6g.large",
                "c6g.xlarge",
                "c6g.2xlarge",
                "c6g.4xlarge",
                "c6g.8xlarge",
                "c6g.12xlarge",
                "c6g.16xlarge",
                "c6g.metal",
                "c6gd.large",
                "c6gd.xlarge",
                "c6gd.2xlarge",
                "c6gd.4xlarge",
                "c6gd.8xlarge",
                "c6gd.12xlarge",
                "c6gd.16xlarge",
                "c6gd.metal",
                "c6gn.large",
                "c6gn.xlarge",
                "c6gn.2xlarge",
                "c6gn.4xlarge",
                "c6gn.8xlarge",
                "c6gn.12xlarge",
                "c6gn.16xlarge",
                "c7g.large",
                "c7g.xlarge",
                "c7g.2xlarge",
                "c7g.4xlarge",
                "c7g.8xlarge",
                "c7g.12xlarge",
                "c7g.16xlarge",
                "c7g.metal",
                "c7gd.large",
                "c7gd.xlarge",
                "c7gd.2xlarge",
                "c7gd.4xlarge",
                "c7gd.8xlarge",
                "c7gd.12xlarge",
                "c7gd.16xlarge",
                "c7gd.metal",
                "g5g.xlarge",
                "g5g.2xlarge",
                "g5g.4xlarge",
                "g5g.8xlarge",
                "g5g.16xlarge",
                "g5g.metal",
                "im4gn.large",
                "im4gn.xlarge",
                "im4gn.2xlarge",
                "im4gn.4xlarge",
                "im4gn.8xlarge",
                "im4gn.16xlarge",
                "is4gen.large",
                "is4gen.xlarge",
                "is4gen.2xlarge",
                "is4gen.4xlarge",
                "is4gen.8xlarge",
                "m6g.large",
                "m6g.xlarge",
                "m6g.2xlarge",
                "m6g.4xlarge",
                "m6g.8xlarge",
                "a1.medium",
                "c6g.medium",
                "c6gd.medium",
                "c6gn.medium",
                "is4gen.medium"
            ]
        },
        "SearchInstanceCount": {
            "Description": "Number of Full Text Search Nodes",
            "Type": "Number",
            "Default": 0
        },
        "SearchInstanceType": {
            "Description": "Instance type for Full Text Search Nodes",
            "Type": "String",
            "Default": "m6g.xlarge",
            "AllowedValues": [
                "m6g.16xlarge",
                "m6g.metal",
                "m6gd.large",
                "m6gd.xlarge",
                "m6gd.2xlarge",
                "m6gd.4xlarge",
                "m6gd.8xlarge",
                "m6gd.12xlarge",
                "m6gd.16xlarge",
                "m6gd.metal",
                "r6g.large",
                "r6g.xlarge",
                "r6g.2xlarge",
                "r6g.4xlarge",
                "r6g.8xlarge",
                "r6g.12xlarge",
                "r6g.16xlarge",
                "r6g.metal",
                "r6gd.large",
                "r6gd.xlarge",
                "r6gd.2xlarge",
                "r6gd.4xlarge",
                "r6gd.8xlarge",
                "r6gd.12xlarge",
                "r6gd.16xlarge",
                "r6gd.metal",
                "r7g.large",
                "r7g.xlarge",
                "r7g.2xlarge",
                "r7g.4xlarge",
                "r7g.8xlarge",
                "r7g.12xlarge",
                "r7g.16xlarge",
                "r7g.metal",
                "r7gd.large",
                "r7gd.xlarge",
                "r7gd.2xlarge",
                "r7gd.4xlarge",
                "r7gd.8xlarge",
                "r7gd.12xlarge",
                "r7gd.16xlarge",
                "r7gd.metal",
                "t4g.nano",
                "t4g.micro",
                "t4g.small",
                "t4g.medium",
                "t4g.large",
                "t4g.xlarge",
                "t4g.2xlarge",
                "x2gd.large",
                "x2gd.xlarge",
                "x2gd.2xlarge",
                "x2gd.4xlarge",
                "x2gd.8xlarge",
                "x2gd.12xlarge",
                "x2gd.16xlarge",
                "x2gd.metal",
                "m6g.12xlarge",
                "a1.large",
                "a1.xlarge",
                "a1.2xlarge",
                "a1.4xlarge",
                "a1.metal",
                "c6g.large",
                "c6g.xlarge",
                "c6g.2xlarge",
                "c6g.4xlarge",
                "c6g.8xlarge",
                "c6g.12xlarge",
                "c6g.16xlarge",
                "c6g.metal",
                "c6gd.large",
                "c6gd.xlarge",
                "c6gd.2xlarge",
                "c6gd.4xlarge",
                "c6gd.8xlarge",
                "c6gd.12xlarge",
                "c6gd.16xlarge",
                "c6gd.metal",
                "c6gn.large",
                "c6gn.xlarge",
                "c6gn.2xlarge",
                "c6gn.4xlarge",
                "c6gn.8xlarge",
                "c6gn.12xlarge",
                "c6gn.16xlarge",
                "c7g.large",
                "c7g.xlarge",
                "c7g.2xlarge",
                "c7g.4xlarge",
                "c7g.8xlarge",
                "c7g.12xlarge",
                "c7g.16xlarge",
                "c7g.metal",
                "c7gd.large",
                "c7gd.xlarge",
                "c7gd.2xlarge",
                "c7gd.4xlarge",
                "c7gd.8xlarge",
                "c7gd.12xlarge",
                "c7gd.16xlarge",
                "c7gd.metal",
                "g5g.xlarge",
                "g5g.2xlarge",
                "g5g.4xlarge",
                "g5g.8xlarge",
                "g5g.16xlarge",
                "g5g.metal",
                "im4gn.large",
                "im4gn.xlarge",
                "im4gn.2xlarge",
                "im4gn.4xlarge",
                "im4gn.8xlarge",
                "im4gn.16xlarge",
                "is4gen.large",
                "is4gen.xlarge",
                "is4gen.2xlarge",
                "is4gen.4xlarge",
                "is4gen.8xlarge",
                "m6g.large",
                "m6g.xlarge",
                "m6g.2xlarge",
                "m6g.4xlarge",
                "m6g.8xlarge",
                "a1.medium",
                "c6g.medium",
                "c6gd.medium",
                "c6gn.medium",
                "is4gen.medium"
            ]
        },
        "BackupInstanceCount": {
            "Description": "Number of Couchbase Backup Nodes",
            "Type": "Number",
            "Default": 0
        },
        "BackupInstanceType": {
            "Description": "Instance type for Couchbase Backup Nodes",
            "Type": "String",
            "Default": "m6g.xlarge",
            "AllowedValues": [
                "m6g.16xlarge",
                "m6g.metal",
                "m6gd.large",
                "m6gd.xlarge",
                "m6gd.2xlarge",
                "m6gd.4xlarge",
                "m6gd.8xlarge",
                "m6gd.12xlarge",
                "m6gd.16xlarge",
                "m6gd.metal",
                "r6g.large",
                "r6g.xlarge",
                "r6g.2xlarge",
                "r6g.4xlarge",
                "r6g.8xlarge",
                "r6g.12xlarge",
                "r6g.16xlarge",
                "r6g.metal",
                "r6gd.large",
                "r6gd.xlarge",
                "r6gd.2xlarge",
                "r6gd.4xlarge",
                "r6gd.8xlarge",
                "r6gd.12xlarge",
                "r6gd.16xlarge",
                "r6gd.metal",
                "r7g.large",
                "r7g.xlarge",
                "r7g.2xlarge",
                "r7g.4xlarge",
                "r7g.8xlarge",
                "r7g.12xlarge",
                "r7g.16xlarge",
                "r7g.metal",
                "r7gd.large",
                "r7gd.xlarge",
                "r7gd.2xlarge",
                "r7gd.4xlarge",
                "r7gd.8xlarge",
                "r7gd.12xlarge",
                "r7gd.16xlarge",
                "r7gd.metal",
                "t4g.nano",
                "t4g.micro",
                "t4g.small",
                "t4g.medium",
                "t4g.large",
                "t4g.xlarge",
                "t4g.2xlarge",
                "x2gd.large",
                "x2gd.xlarge",
                "x2gd.2xlarge",
                "x2gd.4xlarge",
                "x2gd.8xlarge",
                "x2gd.12xlarge",
                "x2gd.16xlarge",
                "x2gd.metal",
                "m6g.12xlarge",
                "a1.large",
                "a1.xlarge",
                "a1.2xlarge",
                "a1.4xlarge",
                "a1.metal",
                "c6g.large",
                "c6g.xlarge",
                "c6g.2xlarge",
                "c6g.4xlarge",
                "c6g.8xlarge",
                "c6g.12xlarge",
                "c6g.16xlarge",
                "c6g.metal",
                "c6gd.large",
                "c6gd.xlarge",
                "c6gd.2xlarge",
                "c6gd.4xlarge",
                "c6gd.8xlarge",
                "c6gd.12xlarge",
                "c6gd.16xlarge",
                "c6gd.metal",
                "c6gn.large",
                "c6gn.xlarge",
                "c6gn.2xlarge",
                "c6gn.4xlarge",
                "c6gn.8xlarge",
                "c6gn.12xlarge",
                "c6gn.16xlarge",
                "c7g.large",
                "c7g.xlarge",
                "c7g.2xlarge",
                "c7g.4xlarge",
                "c7g.8xlarge",
                "c7g.12xlarge",
                "c7g.16xlarge",
                "c7g.metal",
                "c7gd.large",
                "c7gd.xlarge",
                "c7gd.2xlarge",
                "c7gd.4xlarge",
                "c7gd.8xlarge",
                "c7gd.12xlarge",
                "c7gd.16xlarge",
                "c7gd.metal",
                "g5g.xlarge",
                "g5g.2xlarge",
                "g5g.4xlarge",
                "g5g.8xlarge",
                "g5g.16xlarge",
                "g5g.metal",
                "im4gn.large",
                "im4gn.xlarge",
                "im4gn.2xlarge",
                "im4gn.4xlarge",
                "im4gn.8xlarge",
                "im4gn.16xlarge",
                "is4gen.large",
                "is4gen.xlarge",
                "is4gen.2xlarge",
                "is4gen.4xlarge",
                "is4gen.8xlarge",
                "m6g.large",
                "m6g.xlarge",
                "m6g.2xlarge",
                "m6g.4xlarge",
                "m6g.8xlarge",
                "a1.medium",
                "c6g.medium",
                "c6gd.medium",
                "c6gn.medium",
                "is4gen.medium"
            ]
        },
        "DataInstanceCount": {
            "Description": "Number of Couchbase Data Nodes",
            "Type": "Number",
            "Default": 0
        },
        "DataInstanceType": {
            "Description": "Instance type for Couchbase Data Nodes",
            "Type": "String",
            "Default": "m6g.xlarge",
            "AllowedValues": [
                "m6g.16xlarge",
                "m6g.metal",
                "m6gd.large",
                "m6gd.xlarge",
                "m6gd.2xlarge",
                "m6gd.4xlarge",
                "m6gd.8xlarge",
                "m6gd.12xlarge",
                "m6gd.16xlarge",
                "m6gd.metal",
                "r6g.large",
                "r6g.xlarge",
                "r6g.2xlarge",
                "r6g.4xlarge",
                "r6g.8xlarge",
                "r6g.12xlarge",
                "r6g.16xlarge",
                "r6g.metal",
                "r6gd.large",
                "r6gd.xlarge",
                "r6gd.2xlarge",
                "r6gd.4xlarge",
                "r6gd.8xlarge",
                "r6gd.12xlarge",
                "r6gd.16xlarge",
                "r6gd.metal",
                "r7g.large",
                "r7g.xlarge",
                "r7g.2xlarge",
                "r7g.4xlarge",
                "r7g.8xlarge",
                "r7g.12xlarge",
                "r7g.16xlarge",
                "r7g.metal",
                "r7gd.large",
                "r7gd.xlarge",
                "r7gd.2xlarge",
                "r7gd.4xlarge",
                "r7gd.8xlarge",
                "r7gd.12xlarge",
                "r7gd.16xlarge",
                "r7gd.metal",
                "t4g.nano",
                "t4g.micro",
                "t4g.small",
                "t4g.medium",
                "t4g.large",
                "t4g.xlarge",
                "t4g.2xlarge",
                "x2gd.large",
                "x2gd.xlarge",
                "x2gd.2xlarge",
                "x2gd.4xlarge",
                "x2gd.8xlarge",
                "x2gd.12xlarge",
                "x2gd.16xlarge",
                "x2gd.metal",
                "m6g.12xlarge",
                "a1.large",
                "a1.xlarge",
                "a1.2xlarge",
                "a1.4xlarge",
                "a1.metal",
                "c6g.large",
                "c6g.xlarge",
                "c6g.2xlarge",
                "c6g.4xlarge",
                "c6g.8xlarge",
                "c6g.12xlarge",
                "c6g.16xlarge",
                "c6g.metal",
                "c6gd.large",
                "c6gd.xlarge",
                "c6gd.2xlarge",
                "c6gd.4xlarge",
                "c6gd.8xlarge",
                "c6gd.12xlarge",
                "c6gd.16xlarge",
                "c6gd.metal",
                "c6gn.large",
                "c6gn.xlarge",
                "c6gn.2xlarge",
                "c6gn.4xlarge",
                "c6gn.8xlarge",
                "c6gn.12xlarge",
                "c6gn.16xlarge",
                "c7g.large",
                "c7g.xlarge",
                "c7g.2xlarge",
                "c7g.4xlarge",
                "c7g.8xlarge",
                "c7g.12xlarge",
                "c7g.16xlarge",
                "c7g.metal",
                "c7gd.large",
                "c7gd.xlarge",
                "c7gd.2xlarge",
                "c7gd.4xlarge",
                "c7gd.8xlarge",
                "c7gd.12xlarge",
                "c7gd.16xlarge",
                "c7gd.metal",
                "g5g.xlarge",
                "g5g.2xlarge",
                "g5g.4xlarge",
                "g5g.8xlarge",
                "g5g.16xlarge",
                "g5g.metal",
                "im4gn.large",
                "im4gn.xlarge",
                "im4gn.2xlarge",
                "im4gn.4xlarge",
                "im4gn.8xlarge",
                "im4gn.16xlarge",
                "is4gen.large",
                "is4gen.xlarge",
                "is4gen.2xlarge",
                "is4gen.4xlarge",
                "is4gen.8xlarge",
                "m6g.large",
                "m6g.xlarge",
                "m6g.2xlarge",
                "m6g.4xlarge",
                "m6g.8xlarge",
                "a1.medium",
                "c6g.medium",
                "c6gd.medium",
                "c6gn.medium",
                "is4gen.medium"
            ]
        },
        "QueryInstanceCount": {
            "Description": "Number of Couchbase Query Nodes",
            "Type": "Number",
            "Default": 0
        },
        "QueryInstanceType": {
            "Description": "Instance type for Couchbase Query Nodes",
            "Type": "String",
            "Default": "m6g.xlarge",
            "AllowedValues": [
                "m6g.16xlarge",
                "m6g.metal",
                "m6gd.large",
                "m6gd.xlarge",
                "m6gd.2xlarge",
                "m6gd.4xlarge",
                "m6gd.8xlarge",
                "m6gd.12xlarge",
                "m6gd.16xlarge",
                "m6gd.metal",
                "r6g.large",
                "r6g.xlarge",
                "r6g.2xlarge",
                "r6g.4xlarge",
                "r6g.8xlarge",
                "r6g.12xlarge",
                "r6g.16xlarge",
                "r6g.metal",
                "r6gd.large",
                "r6gd.xlarge",
                "r6gd.2xlarge",
                "r6gd.4xlarge",
                "r6gd.8xlarge",
                "r6gd.12xlarge",
                "r6gd.16xlarge",
                "r6gd.metal",
                "r7g.large",
                "r7g.xlarge",
                "r7g.2xlarge",
                "r7g.4xlarge",
                "r7g.8xlarge",
                "r7g.12xlarge",
                "r7g.16xlarge",
                "r7g.metal",
                "r7gd.large",
                "r7gd.xlarge",
                "r7gd.2xlarge",
                "r7gd.4xlarge",
                "r7gd.8xlarge",
                "r7gd.12xlarge",
                "r7gd.16xlarge",
                "r7gd.metal",
                "t4g.nano",
                "t4g.micro",
                "t4g.small",
                "t4g.medium",
                "t4g.large",
                "t4g.xlarge",
                "t4g.2xlarge",
                "x2gd.large",
                "x2gd.xlarge",
                "x2gd.2xlarge",
                "x2gd.4xlarge",
                "x2gd.8xlarge",
                "x2gd.12xlarge",
                "x2gd.16xlarge",
                "x2gd.metal",
                "m6g.12xlarge",
                "a1.large",
                "a1.xlarge",
                "a1.2xlarge",
                "a1.4xlarge",
                "a1.metal",
                "c6g.large",
                "c6g.xlarge",
                "c6g.2xlarge",
                "c6g.4xlarge",
                "c6g.8xlarge",
                "c6g.12xlarge",
                "c6g.16xlarge",
                "c6g.metal",
                "c6gd.large",
                "c6gd.xlarge",
                "c6gd.2xlarge",
                "c6gd.4xlarge",
                "c6gd.8xlarge",
                "c6gd.12xlarge",
                "c6gd.16xlarge",
                "c6gd.metal",
                "c6gn.large",
                "c6gn.xlarge",
                "c6gn.2xlarge",
                "c6gn.4xlarge",
                "c6gn.8xlarge",
                "c6gn.12xlarge",
                "c6gn.16xlarge",
                "c7g.large",
                "c7g.xlarge",
                "c7g.2xlarge",
                "c7g.4xlarge",
                "c7g.8xlarge",
                "c7g.12xlarge",
                "c7g.16xlarge",
                "c7g.metal",
                "c7gd.large",
                "c7gd.xlarge",
                "c7gd.2xlarge",
                "c7gd.4xlarge",
                "c7gd.8xlarge",
                "c7gd.12xlarge",
                "c7gd.16xlarge",
                "c7gd.metal",
                "g5g.xlarge",
                "g5g.2xlarge",
                "g5g.4xlarge",
                "g5g.8xlarge",
                "g5g.16xlarge",
                "g5g.metal",
                "im4gn.large",
                "im4gn.xlarge",
                "im4gn.2xlarge",
                "im4gn.4xlarge",
                "im4gn.8xlarge",
                "im4gn.16xlarge",
                "is4gen.large",
                "is4gen.xlarge",
                "is4gen.2xlarge",
                "is4gen.4xlarge",
                "is4gen.8xlarge",
                "m6g.large",
                "m6g.xlarge",
                "m6g.2xlarge",
                "m6g.4xlarge",
                "m6g.8xlarge",
                "a1.medium",
                "c6g.medium",
                "c6gd.medium",
                "c6gn.medium",
                "is4gen.medium"
            ]
        },
        "IndexInstanceCount": {
            "Description": "Number of Couchbase Index Nodes",
            "Type": "Number",
            "Default": 0
        },
        "IndexInstanceType": {
            "Description": "Instance type for Couchbase Index Nodes",
            "Type": "String",
            "Default": "m6g.xlarge",
            "AllowedValues": [
                "m6g.16xlarge",
                "m6g.metal",
                "m6gd.large",
                "m6gd.xlarge",
                "m6gd.2xlarge",
                "m6gd.4xlarge",
                "m6gd.8xlarge",
                "m6gd.12xlarge",
                "m6gd.16xlarge",
                "m6gd.metal",
                "r6g.large",
                "r6g.xlarge",
                "r6g.2xlarge",
                "r6g.4xlarge",
                "r6g.8xlarge",
                "r6g.12xlarge",
                "r6g.16xlarge",
                "r6g.metal",
                "r6gd.large",
                "r6gd.xlarge",
                "r6gd.2xlarge",
                "r6gd.4xlarge",
                "r6gd.8xlarge",
                "r6gd.12xlarge",
                "r6gd.16xlarge",
                "r6gd.metal",
                "r7g.large",
                "r7g.xlarge",
                "r7g.2xlarge",
                "r7g.4xlarge",
                "r7g.8xlarge",
                "r7g.12xlarge",
                "r7g.16xlarge",
                "r7g.metal",
                "r7gd.large",
                "r7gd.xlarge",
                "r7gd.2xlarge",
                "r7gd.4xlarge",
                "r7gd.8xlarge",
                "r7gd.12xlarge",
                "r7gd.16xlarge",
                "r7gd.metal",
                "t4g.nano",
                "t4g.micro",
                "t4g.small",
                "t4g.medium",
                "t4g.large",
                "t4g.xlarge",
                "t4g.2xlarge",
                "x2gd.large",
                "x2gd.xlarge",
                "x2gd.2xlarge",
                "x2gd.4xlarge",
                "x2gd.8xlarge",
                "x2gd.12xlarge",
                "x2gd.16xlarge",
                "x2gd.metal",
                "m6g.12xlarge",
                "a1.large",
                "a1.xlarge",
                "a1.2xlarge",
                "a1.4xlarge",
                "a1.metal",
                "c6g.large",
                "c6g.xlarge",
                "c6g.2xlarge",
                "c6g.4xlarge",
                "c6g.8xlarge",
                "c6g.12xlarge",
                "c6g.16xlarge",
                "c6g.metal",
                "c6gd.large",
                "c6gd.xlarge",
                "c6gd.2xlarge",
                "c6gd.4xlarge",
                "c6gd.8xlarge",
                "c6gd.12xlarge",
                "c6gd.16xlarge",
                "c6gd.metal",
                "c6gn.large",
                "c6gn.xlarge",
                "c6gn.2xlarge",
                "c6gn.4xlarge",
                "c6gn.8xlarge",
                "c6gn.12xlarge",
                "c6gn.16xlarge",
                "c7g.large",
                "c7g.xlarge",
                "c7g.2xlarge",
                "c7g.4xlarge",
                "c7g.8xlarge",
                "c7g.12xlarge",
                "c7g.16xlarge",
                "c7g.metal",
                "c7gd.large",
                "c7gd.xlarge",
                "c7gd.2xlarge",
                "c7gd.4xlarge",
                "c7gd.8xlarge",
                "c7gd.12xlarge",
                "c7gd.16xlarge",
                "c7gd.metal",
                "g5g.xlarge",
                "g5g.2xlarge",
                "g5g.4xlarge",
                "g5g.8xlarge",
                "g5g.16xlarge",
                "g5g.metal",
                "im4gn.large",
                "im4gn.xlarge",
                "im4gn.2xlarge",
                "im4gn.4xlarge",
                "im4gn.8xlarge",
                "im4gn.16xlarge",
                "is4gen.large",
                "is4gen.xlarge",
                "is4gen.2xlarge",
                "is4gen.4xlarge",
                "is4gen.8xlarge",
                "m6g.large",
                "m6g.xlarge",
                "m6g.2xlarge",
                "m6g.4xlarge",
                "m6g.8xlarge",
                "a1.medium",
                "c6g.medium",
                "c6gd.medium",
                "c6gn.medium",
                "is4gen.medium"
            ]
        }
    },
    "Resources": {
        "CouchbaseSecret": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Name": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            "-CouchbaseSecret"
                        ]
                    ]
                },
                "Description": "Couchbase Admin Username/Password Secret",
                "SecretString": {
                    "Fn::Join": [
                        "",
                        [
                            "{\"username\": \"",
                            {
                                "Ref": "Username"
                            },
                            "\", \"password\":\"",
                            {
                                "Ref": "Password"
                            },
                            "\"}"
                        ]
                    ]
                }
            }
        },
        "CouchbaseRallyPoint": {
            "Type": "AWS::SSM::Parameter",
            "Properties": {
                "Description": "The Rally point dns entry for new nodes to join the cluster with.",
                "Name": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            "-couchbase-server-rally-url"
                        ]
                    ]
                },
                "Type": "String",
                "Value": "None"
            }
        },
        "CoreAutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "CoreLaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "CoreLaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "MinSize": "1",
                "MaxSize": "100",
                "DesiredCapacity": {
                    "Ref": "CoreInstanceCount"
                },
                "VPCZoneIdentifier": {
                    "Ref": "Subnets"
                }
            },
            "CreationPolicy": {
                "ResourceSignal": {
                    "Count": {
                        "Ref": "CoreInstanceCount"
                    },
                    "Timeout": "PT15M"
                }
            },
            "DependsOn": [
                "CouchbaseSecret"
            ]
        },
        "CoreLaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateData": {
                    "MetadataOptions": {
                        "InstanceMetadataTags": "enabled"
                    },
                    "ImageId": {
                        "Fn::FindInMap": [
                            "CouchbaseServer",
                            {
                                "Ref": "AWS::Region"
                            },
                            "AMI"
                        ]
                    },
                    "InstanceType": {
                        "Ref": "CoreInstanceType"
                    },
                    "SecurityGroupIds": [
                        {
                            "Fn::GetAtt": [
                                "CouchbaseServerSecurityGroup",
                                "GroupId"
                            ]
                        }
                    ],
                    "KeyName": {
                        "Ref": "KeyName"
                    },
                    "EbsOptimized": true,
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "CouchbaseInstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvda",
                            "Ebs": {
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "DeleteOnTermination": true
                            }
                        },
                        {
                            "DeviceName": "/dev/sdk",
                            "Ebs": {
                                "VolumeSize": {
                                    "Ref": "CoreDiskSize"
                                },
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "Encrypted": true
                            }
                        }
                    ],
                    "UserData": "",
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "couchbase:server:services",
                                    "Value": {
                                        "Fn::Join": [
                                            ",",
                                            {
                                                "Ref": "CoreServices"
                                            }
                                        ]
                                    }
                                },
                                {
                                    "Key": "couchbase:server:secret",
                                    "Value": {
                                        "Ref": "CouchbaseSecret"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:version",
                                    "Value": {
                                        "Ref": "ServerVersion"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:rally_parameter",
                                    "Value": {
                                        "Ref": "CouchbaseRallyPoint"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:make_cluster",
                                    "Value": "true"
                                },
                                {
                                    "Key": "couchbase:server:disk",
                                    "Value": "/dev/sdk"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "AnalyticsAutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "AnalyticsLaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "AnalyticsLaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "MinSize": "0",
                "MaxSize": "100",
                "DesiredCapacity": {
                    "Ref": "AnalyticsInstanceCount"
                },
                "VPCZoneIdentifier": {
                    "Ref": "Subnets"
                }
            },
            "CreationPolicy": {
                "ResourceSignal": {
                    "Count": {
                        "Ref": "AnalyticsInstanceCount"
                    },
                    "Timeout": "PT15M"
                }
            },
            "DependsOn": [
                "CouchbaseSecret",
                "CoreAutoScalingGroup"
            ]
        },
        "AnalyticsLaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateData": {
                    "MetadataOptions": {
                        "InstanceMetadataTags": "enabled"
                    },
                    "ImageId": {
                        "Fn::FindInMap": [
                            "CouchbaseServer",
                            {
                                "Ref": "AWS::Region"
                            },
                            "AMI"
                        ]
                    },
                    "InstanceType": {
                        "Ref": "AnalyticsInstanceType"
                    },
                    "SecurityGroupIds": [
                        {
                            "Fn::GetAtt": [
                                "CouchbaseServerSecurityGroup",
                                "GroupId"
                            ]
                        }
                    ],
                    "KeyName": {
                        "Ref": "KeyName"
                    },
                    "EbsOptimized": true,
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "CouchbaseInstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvda",
                            "Ebs": {
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "DeleteOnTermination": true
                            }
                        },
                        {
                            "DeviceName": "/dev/sdk",
                            "Ebs": {
                                "VolumeSize": {
                                    "Ref": "CoreDiskSize"
                                },
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "Encrypted": true
                            }
                        }
                    ],
                    "UserData": "",
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "couchbase:server:services",
                                    "Value": "analytics"
                                },
                                {
                                    "Key": "couchbase:server:version",
                                    "Value": {
                                        "Ref": "ServerVersion"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:rally_parameter",
                                    "Value": {
                                        "Ref": "CouchbaseRallyPoint"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:secret",
                                    "Value": {
                                        "Ref": "CouchbaseSecret"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:disk",
                                    "Value": "/dev/sdk"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "EventingAutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "EventingLaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "EventingLaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "MinSize": "0",
                "MaxSize": "100",
                "DesiredCapacity": {
                    "Ref": "EventingInstanceCount"
                },
                "VPCZoneIdentifier": {
                    "Ref": "Subnets"
                }
            },
            "CreationPolicy": {
                "ResourceSignal": {
                    "Count": {
                        "Ref": "EventingInstanceCount"
                    },
                    "Timeout": "PT15M"
                }
            },
            "DependsOn": [
                "CouchbaseSecret",
                "CoreAutoScalingGroup"
            ]
        },
        "EventingLaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateData": {
                    "MetadataOptions": {
                        "InstanceMetadataTags": "enabled"
                    },
                    "ImageId": {
                        "Fn::FindInMap": [
                            "CouchbaseServer",
                            {
                                "Ref": "AWS::Region"
                            },
                            "AMI"
                        ]
                    },
                    "InstanceType": {
                        "Ref": "EventingInstanceType"
                    },
                    "SecurityGroupIds": [
                        {
                            "Fn::GetAtt": [
                                "CouchbaseServerSecurityGroup",
                                "GroupId"
                            ]
                        }
                    ],
                    "KeyName": {
                        "Ref": "KeyName"
                    },
                    "EbsOptimized": true,
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "CouchbaseInstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvda",
                            "Ebs": {
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "DeleteOnTermination": true
                            }
                        },
                        {
                            "DeviceName": "/dev/sdk",
                            "Ebs": {
                                "VolumeSize": {
                                    "Ref": "CoreDiskSize"
                                },
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "Encrypted": true
                            }
                        }
                    ],
                    "UserData": "",
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "couchbase:server:services",
                                    "Value": "eventing"
                                },
                                {
                                    "Key": "couchbase:server:rally_parameter",
                                    "Value": {
                                        "Ref": "CouchbaseRallyPoint"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:secret",
                                    "Value": {
                                        "Ref": "CouchbaseSecret"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:version",
                                    "Value": {
                                        "Ref": "ServerVersion"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:disk",
                                    "Value": "/dev/sdk"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "SearchAutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "SearchLaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "SearchLaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "MinSize": "0",
                "MaxSize": "100",
                "DesiredCapacity": {
                    "Ref": "SearchInstanceCount"
                },
                "VPCZoneIdentifier": {
                    "Ref": "Subnets"
                }
            },
            "CreationPolicy": {
                "ResourceSignal": {
                    "Count": {
                        "Ref": "SearchInstanceCount"
                    },
                    "Timeout": "PT15M"
                }
            },
            "DependsOn": [
                "CouchbaseSecret",
                "CoreAutoScalingGroup"
            ]
        },
        "SearchLaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateData": {
                    "MetadataOptions": {
                        "InstanceMetadataTags": "enabled"
                    },
                    "ImageId": {
                        "Fn::FindInMap": [
                            "CouchbaseServer",
                            {
                                "Ref": "AWS::Region"
                            },
                            "AMI"
                        ]
                    },
                    "InstanceType": {
                        "Ref": "SearchInstanceType"
                    },
                    "SecurityGroupIds": [
                        {
                            "Fn::GetAtt": [
                                "CouchbaseServerSecurityGroup",
                                "GroupId"
                            ]
                        }
                    ],
                    "KeyName": {
                        "Ref": "KeyName"
                    },
                    "EbsOptimized": true,
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "CouchbaseInstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvda",
                            "Ebs": {
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "DeleteOnTermination": true
                            }
                        },
                        {
                            "DeviceName": "/dev/sdk",
                            "Ebs": {
                                "VolumeSize": {
                                    "Ref": "CoreDiskSize"
                                },
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "Encrypted": true
                            }
                        }
                    ],
                    "UserData": "",
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "couchbase:server:services",
                                    "Value": "fts"
                                }, {
                                    "Key": "couchbase:server:rally_parameter",
                                    "Value": {
                                        "Ref": "CouchbaseRallyPoint"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:secret",
                                    "Value": {
                                        "Ref": "CouchbaseSecret"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:version",
                                    "Value": {
                                        "Ref": "ServerVersion"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:disk",
                                    "Value": "/dev/sdk"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "BackupAutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "BackupLaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "BackupLaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "MinSize": "0",
                "MaxSize": "100",
                "DesiredCapacity": {
                    "Ref": "BackupInstanceCount"
                },
                "VPCZoneIdentifier": {
                    "Ref": "Subnets"
                }
            },
            "CreationPolicy": {
                "ResourceSignal": {
                    "Count": {
                        "Ref": "BackupInstanceCount"
                    },
                    "Timeout": "PT15M"
                }
            },
            "DependsOn": [
                "CouchbaseSecret",
                "CoreAutoScalingGroup"
            ]
        },
        "BackupLaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateData": {
                    "MetadataOptions": {
                        "InstanceMetadataTags": "enabled"
                    },
                    "ImageId": {
                        "Fn::FindInMap": [
                            "CouchbaseServer",
                            {
                                "Ref": "AWS::Region"
                            },
                            "AMI"
                        ]
                    },
                    "InstanceType": {
                        "Ref": "BackupInstanceType"
                    },
                    "SecurityGroupIds": [
                        {
                            "Fn::GetAtt": [
                                "CouchbaseServerSecurityGroup",
                                "GroupId"
                            ]
                        }
                    ],
                    "KeyName": {
                        "Ref": "KeyName"
                    },
                    "EbsOptimized": true,
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "CouchbaseInstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvda",
                            "Ebs": {
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "DeleteOnTermination": true
                            }
                        },
                        {
                            "DeviceName": "/dev/sdk",
                            "Ebs": {
                                "VolumeSize": {
                                    "Ref": "CoreDiskSize"
                                },
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "Encrypted": true
                            }
                        }
                    ],
                    "UserData": "",
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "couchbase:server:services",
                                    "Value": "backup"
                                }, {
                                    "Key": "couchbase:server:rally_parameter",
                                    "Value": {
                                        "Ref": "CouchbaseRallyPoint"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:secret",
                                    "Value": {
                                        "Ref": "CouchbaseSecret"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:version",
                                    "Value": {
                                        "Ref": "ServerVersion"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:disk",
                                    "Value": "/dev/sdk"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "DataAutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "DataLaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "DataLaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "MinSize": "0",
                "MaxSize": "100",
                "DesiredCapacity": {
                    "Ref": "DataInstanceCount"
                },
                "VPCZoneIdentifier": {
                    "Ref": "Subnets"
                }
            },
            "CreationPolicy": {
                "ResourceSignal": {
                    "Count": {
                        "Ref": "DataInstanceCount"
                    },
                    "Timeout": "PT15M"
                }
            },
            "DependsOn": [
                "CouchbaseSecret",
                "CoreAutoScalingGroup"
            ]
        },
        "DataLaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateData": {
                    "MetadataOptions": {
                        "InstanceMetadataTags": "enabled"
                    },
                    "ImageId": {
                        "Fn::FindInMap": [
                            "CouchbaseServer",
                            {
                                "Ref": "AWS::Region"
                            },
                            "AMI"
                        ]
                    },
                    "InstanceType": {
                        "Ref": "DataInstanceType"
                    },
                    "SecurityGroupIds": [
                        {
                            "Fn::GetAtt": [
                                "CouchbaseServerSecurityGroup",
                                "GroupId"
                            ]
                        }
                    ],
                    "KeyName": {
                        "Ref": "KeyName"
                    },
                    "EbsOptimized": true,
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "CouchbaseInstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvda",
                            "Ebs": {
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "DeleteOnTermination": true
                            }
                        },
                        {
                            "DeviceName": "/dev/sdk",
                            "Ebs": {
                                "VolumeSize": {
                                    "Ref": "CoreDiskSize"
                                },
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "Encrypted": true
                            }
                        }
                    ],
                    "UserData": "",
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "couchbase:server:services",
                                    "Value": "data"
                                }, {
                                    "Key": "couchbase:server:rally_parameter",
                                    "Value": {
                                        "Ref": "CouchbaseRallyPoint"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:secret",
                                    "Value": {
                                        "Ref": "CouchbaseSecret"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:version",
                                    "Value": {
                                        "Ref": "ServerVersion"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:disk",
                                    "Value": "/dev/sdk"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "IndexAutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "IndexLaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "IndexLaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "MinSize": "0",
                "MaxSize": "100",
                "DesiredCapacity": {
                    "Ref": "IndexInstanceCount"
                },
                "VPCZoneIdentifier": {
                    "Ref": "Subnets"
                }
            },
            "CreationPolicy": {
                "ResourceSignal": {
                    "Count": {
                        "Ref": "IndexInstanceCount"
                    },
                    "Timeout": "PT15M"
                }
            },
            "DependsOn": [
                "CouchbaseSecret",
                "CoreAutoScalingGroup"
            ]
        },
        "IndexLaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateData": {
                    "MetadataOptions": {
                        "InstanceMetadataTags": "enabled"
                    },
                    "ImageId": {
                        "Fn::FindInMap": [
                            "CouchbaseServer",
                            {
                                "Ref": "AWS::Region"
                            },
                            "AMI"
                        ]
                    },
                    "InstanceType": {
                        "Ref": "IndexInstanceType"
                    },
                    "SecurityGroupIds": [
                        {
                            "Fn::GetAtt": [
                                "CouchbaseServerSecurityGroup",
                                "GroupId"
                            ]
                        }
                    ],
                    "KeyName": {
                        "Ref": "KeyName"
                    },
                    "EbsOptimized": true,
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "CouchbaseInstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvda",
                            "Ebs": {
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "DeleteOnTermination": true
                            }
                        },
                        {
                            "DeviceName": "/dev/sdk",
                            "Ebs": {
                                "VolumeSize": {
                                    "Ref": "CoreDiskSize"
                                },
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "Encrypted": true
                            }
                        }
                    ],
                    "UserData": "",
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "couchbase:server:services",
                                    "Value": "index"
                                }, {
                                    "Key": "couchbase:server:rally_parameter",
                                    "Value": {
                                        "Ref":  "CouchbaseRallyPoint"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:secret",
                                    "Value": {
                                        "Ref": "CouchbaseSecret"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:version",
                                    "Value": {
                                        "Ref": "ServerVersion"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:disk",
                                    "Value": "/dev/sdk"
                                }
                            ]
                        }
                    ]
                }
            }
        },
        "QueryAutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "LaunchTemplate": {
                    "LaunchTemplateId": {
                        "Ref": "QueryLaunchTemplate"
                    },
                    "Version": {
                        "Fn::GetAtt": [
                            "QueryLaunchTemplate",
                            "LatestVersionNumber"
                        ]
                    }
                },
                "MinSize": "0",
                "MaxSize": "100",
                "DesiredCapacity": {
                    "Ref": "QueryInstanceCount"
                },
                "VPCZoneIdentifier": {
                    "Ref": "Subnets"
                }
            },
            "CreationPolicy": {
                "ResourceSignal": {
                    "Count": {
                        "Ref": "QueryInstanceCount"
                    },
                    "Timeout": "PT15M"
                }
            },
            "DependsOn": [
                "CouchbaseSecret",
                "CoreAutoScalingGroup"
            ]
        },
        "QueryLaunchTemplate": {
            "Type": "AWS::EC2::LaunchTemplate",
            "Properties": {
                "LaunchTemplateData": {
                    "MetadataOptions": {
                        "InstanceMetadataTags": "enabled"
                    },
                    "ImageId": {
                        "Fn::FindInMap": [
                            "CouchbaseServer",
                            {
                                "Ref": "AWS::Region"
                            },
                            "AMI"
                        ]
                    },
                    "InstanceType": {
                        "Ref": "QueryInstanceType"
                    },
                    "SecurityGroupIds": [
                        {
                            "Fn::GetAtt": [
                                "CouchbaseServerSecurityGroup",
                                "GroupId"
                            ]
                        }
                    ],
                    "KeyName": {
                        "Ref": "KeyName"
                    },
                    "EbsOptimized": true,
                    "IamInstanceProfile": {
                        "Arn": {
                            "Fn::GetAtt": [
                                "CouchbaseInstanceProfile",
                                "Arn"
                            ]
                        }
                    },
                    "BlockDeviceMappings": [
                        {
                            "DeviceName": "/dev/xvda",
                            "Ebs": {
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "DeleteOnTermination": true
                            }
                        },
                        {
                            "DeviceName": "/dev/sdk",
                            "Ebs": {
                                "VolumeSize": {
                                    "Ref": "CoreDiskSize"
                                },
                                "VolumeType": {
                                    "Ref": "CoreDiskType"
                                },
                                "Encrypted": true
                            }
                        }
                    ],
                    "UserData": "",
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "couchbase:server:services",
                                    "Value": "query"
                                }, {
                                    "Key": "couchbase:server:rally_parameter",
                                    "Value": {
                                        "Ref":  "CouchbaseRallyPoint"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:secret",
                                    "Value": {
                                        "Ref": "CouchbaseSecret"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:version",
                                    "Value": {
                                        "Ref": "ServerVersion"
                                    }
                                },
                                {
                                    "Key": "couchbase:server:disk",
                                    "Value": "/dev/sdk"
                                }
                            ]
                        }
                    ]
                }
            }
        },        
        "CouchbaseInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Roles": [
                    {
                        "Ref": "CouchbaseRole"
                    }
                ]
            }
        },
        "CouchbaseRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Policies": [
                    {
                        "PolicyName": "CouchbasePolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:CreateTags",
                                        "ec2:DescribeTags",
                                        "ec2:DescribeInstances",
                                        "autoscaling:DescribeAutoScalingGroups"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "CouchbaseSecretPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "secretsmanager:GetSecretValue"
                                    ],
                                    "Resource": [
                                        {
                                            "Ref": "CouchbaseSecret"
                                        }
                                    ]
                                }
                            ]
                        }
                    }, 
                    {
                        "PolicyName": "CouchbaseRallyParameterPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssm:PutParameter",
                                        "ssm:GetParameter",
                                        "ssm:AddTagsToResource"
                                    ],
                                    "Resource": [
                                       "*"
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "CouchbaseServerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable SSH and Couchbase Ports",
                "VpcId": {
                    "Ref": "VpcName"
                },
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "Description": "Outbound Access",
                        "FromPort": 0,
                        "ToPort": 65535,
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "Description": "SSH Ingress port",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": {
                            "Ref": "SSHCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "Description": "Couchbase Server Ports",
                        "FromPort": 4369,
                        "ToPort": 4369,
                        "CidrIp": {
                            "Ref": "SSHCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "Description": "Couchbase Server Ports",
                        "FromPort": 4984,
                        "ToPort": 4985,
                        "CidrIp": {
                            "Ref": "SSHCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "Description": "Couchbase Server Admin API Port",
                        "FromPort": 8091,
                        "ToPort": 8096,
                        "CidrIp": {
                            "Ref": "SSHCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "Description": "Couchbase Server Ports",
                        "FromPort": 9100,
                        "ToPort": 9105,
                        "CidrIp": {
                            "Ref": "SSHCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "Description": "Couchbase Server Ports",
                        "FromPort": 9110,
                        "ToPort": 9122,
                        "CidrIp": {
                            "Ref": "SSHCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "Description": "Couchbase Server Ports",
                        "FromPort": 9130,
                        "ToPort": 9130,
                        "CidrIp": {
                            "Ref": "SSHCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "Description": "Couchbase Server Ports",
                        "FromPort": 9998,
                        "ToPort": 9999,
                        "CidrIp": {
                            "Ref": "SSHCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "Description": "Couchbase Server Ports",
                        "FromPort": 11207,
                        "ToPort": 11215,
                        "CidrIp": {
                            "Ref": "SSHCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "Description": "Couchbase Server Ports",
                        "FromPort": 18091,
                        "ToPort": 18096,
                        "CidrIp": {
                            "Ref": "SSHCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "Description": "Couchbase Server Ports",
                        "FromPort": 21100,
                        "ToPort": 21299,
                        "CidrIp": {
                            "Ref": "SSHCIDR"
                        }
                    }
                ]
            }
        }
    },
    "Outputs": {
        "CouchbaseBootstrapParameter": { "Value": {"Ref": "CouchbaseRallyPoint" }},
        "CouchbaseSecretArn": {"Value": { "Ref": "CouchbaseSecret" }}
    }
}